
<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.53" />

    
    
    

<title>Waffle : Windows Single Sign On • A Morsel Of Code</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Waffle : Windows Single Sign On"/>
<meta name="twitter:description" content="Last week, I was working on an application where I had to do LDAP authentication. My cmpany has been using a very old jar file that had the required code for authenticating and authorizing users. There were two problems for me.
 I had to revisit the documentation on LDAP setting in Jboss 4 and figure how to do the set up. Making changes in login-config.xml etc.
 My new application is using Spring-boot, which comes with built in tomcat libraries."/>

<meta property="og:title" content="Waffle : Windows Single Sign On" />
<meta property="og:description" content="Last week, I was working on an application where I had to do LDAP authentication. My cmpany has been using a very old jar file that had the required code for authenticating and authorizing users. There were two problems for me.
 I had to revisit the documentation on LDAP setting in Jboss 4 and figure how to do the set up. Making changes in login-config.xml etc.
 My new application is using Spring-boot, which comes with built in tomcat libraries." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2015/09/27/waffle-windows-single-sign-on/" /><meta property="article:published_time" content="2015-09-27T22:38:03&#43;00:00"/>
<meta property="article:modified_time" content="2015-09-27T22:38:03&#43;00:00"/>



<link rel="canonical" href="/2015/09/27/waffle-windows-single-sign-on/" />

<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="icon" href="/favicon.ico" type="image/x-icon">





<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Allerta+Stencil">

<link rel="stylesheet" href="/css/w3.css" />


<link rel="stylesheet" href="/css/style.css" />







  
  
</head>
<body }

class="w3-light-grey">



    <header id="header">
      
          
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-47631412-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-47631412-1');
</script>

<div class="w3-right ">
<div class="w3-bar w3-light-grey  ">
  
  <span class="w3-bar-item w3-left " id="google_translate_element"></span>
<script>
  function googleTranslateElementInit() {
    new google.translate.TranslateElement(
      {
          pageLanguage: 'en'
        , layout: google.translate.TranslateElement.FloatPosition.TOP_RIGHT
        , multilanguagePage: true
      }
      , 'google_translate_element'
    );
  }
</script>
<script async src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>


  
       <a href="javascript:void(0)" class="w3-bar-item w3-button w3-hover-green" title="Search" onclick="displaysearch()"><i class="fa fa-search"></i></a>
  
      <span class="w3-hide-small">

        <a href="mailto:dinesh19aug@gmail.com" class="w3-bar-item w3-button w3-hover-green"><i class="fa fa-envelope"></i></a>

        <a href="https://stackoverflow.com/users/1172194/dinesh-arora" class="w3-bar-item w3-button w3-hover-green"><i class="fa fa-stack-overflow"></i></a>

        <a href="https://twitter.com/dinesh19aug" class="w3-bar-item w3-button w3-hover-green"><i class="fa fa-twitter"></i></a>

        <a href="https://github.com/dinesh19aug" class="w3-bar-item w3-button w3-hover-green"><i class="fa fa-github"></i></a>

        <a href="https://www.linkedin.com/in/dinesharora" class="w3-bar-item w3-button w3-hover-green"><i class="fa fa-linkedin"></i></a>

        <a href="https://github.com/dinesh19aug" class="w3-bar-item w3-button w3-hover-green"><i class="fa fa-github"></i></a>

      </span>

</div>
</div>
<br>
  <div class="w3-content">

  <div class="w3-container w3-center w3-padding-32 w3-hide-small">
      <h1 class="w3-xxxlarge w3-text-blue w3-wide w3-allerta  " style="text-shadow:1px 1px 0 #444" ><u>
      
         A Morsel Of Code - One Byte At A Time
      
</u></h1>

    </div>
    <div class="w3-content w3-center">
    <div class="w3-bar w3-light-grey w3-border">
    <a href="/" class="w3-bar-item w3-button w3-large w3-green"><i class="fa fa-home"></i></a>
    
      <a href="/categories/" class="w3-bar-item w3-button w3-hide-small">Categories</a>
    
      <a href="/tags/" class="w3-bar-item w3-button w3-hide-small">Tags</a>
    


    <a href="javascript:void(0)" class="w3-bar-item w3-button w3-right w3-hide-large w3-hide-medium" onclick="displaymenu()">&#9776;</a>
  </div>

<div id="mobilemenu" class="w3-bar-block w3-light-grey w3-hide w3-hide-large w3-hide-medium">
  
      <a href="/categories/" class="w3-bar-item w3-button">Categories</a>
      
      <a href="/tags/" class="w3-bar-item w3-button">Tags</a>
      

</div>
</div>
</div>
<script>
function displaymenu() {
    var x = document.getElementById("mobilemenu");
    if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
    } else {
        x.className = x.className.replace(" w3-show", "");
    }
}
</script>



  <div id="searchOverlay" class="overlay w3-hide">
    <span class="closebtn" onclick="displaysearch()" title="Close Overlay">×</span>
    <div class="overlay-content">
        <form action="/search/">
          <input type="text" placeholder="Search.." name="q">
          <button type="submit"><i class="fa fa-search"></i></button>
        </form>
    </div>
  </div>

  <script>
  function displaysearch() {
    var x = document.getElementById("searchOverlay");
    if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
    } else {
        x.className = x.className.replace(" w3-show", "");
    }

  }


  </script>





    <hr class="headfoot">

      
    </header>

<div class="w3-content">

      <div>
        <div id="content" >
          
    

      <div id="toc" class="w3-dropdown-hover w3-hide-small w3-hide-medium">
    <button class="w3-button w3-teal w3-xlarge">&#9776;</button>
    <div class="w3-dropdown-content w3-bar-block w3-border" style="right:0">
         
          <h3 class="w3-center">Contents </h3>
            <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#what-is-waffle">What is waffle?</a></li>
<li><a href="#set-up">Set Up::</a>
<ul>
<li><a href="#scenario-1-logon-a-user-and-get-his-domain-and-local-groups">Scenario 1: Logon a user and get his domain and local groups</a></li>
<li><a href="#scenario-2-active-directory-get-the-list-of-trusted-domains">Scenario 2: Active directory: get the list of trusted domains</a></li>
<li><a href="#scenario-3-is-computer-active-on-a-domain">Scenario 3:: Is computer active on a domain?</a></li>
<li><a href="#scenario-4-negotiate-single-sign-on">Scenario 4: Negotiate Single Sign on</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
         
      </div>

     
      </div>
    

 
     


  <div class="w3-content w3-card-4" >
    
    <header class="w3-container w3-center w3-padding-32">
      <h1>Waffle : Windows Single Sign On</h1>

      <div >
        <p> 2015-09-27 
          
             <code> 658 words  </code>
             <code> 4 mins read </code>
          
        </p>
        <div >
            
              <a class="w3-btn w3-small w3-round w3-green" href="/categories/tech-notes/"> Tech Notes </a>
            
          </div>
       
        
      </div>
    </header>

   
    
    <div class="w3-container">
      
        

        
        

        
          

<p>Last week, I was working on an application where I had to do LDAP authentication. My cmpany has been using a very old jar file that had the required code for authenticating and authorizing users. There were two problems for me.</p>

<ol>
<li><p>I had to revisit the documentation on LDAP setting in Jboss 4 and figure how to do the set up. Making changes in login-config.xml etc.</p></li>

<li><p>My new application is using Spring-boot, which comes with built in tomcat libraries. I had to either find some documentation on Timcat with Spring boot 4 or build the app as war and deploy in Jboss 7 and not Jboss 4, which means going over documentation and tutorial.</p></li>
</ol>

<h3 id="what-is-waffle">What is waffle?</h3>

<p>While trying to figure out a lazy way of doing things, I ran into Waffle project. <a href="https://github.com/dblock/waffle" target="_blank">WAFFLE </a>is a native Windows Authentication Framework consisting of two C# and Java libraries that perform functions related to Windows authentication, supporting Negotiate, NTLM and Kerberos. Waffle also includes libraries that enable drop-in Windows Single Sign On for popular Java web servers, when running on Windows. While Waffle makes it ridiculously easy to do Windows Authentication in Java, on Windows, Waffle does not work on *nix. In Short, if a user logs into his company computer, he would be authenticating over LDAP to make sure that he is authorized to use the computer. Waffle gives you an opportunity to make use of the exixsting infrastrutuce and help you authenticate and authorzie the user.</p>

<h3 id="set-up">Set Up::</h3>

<p>To use waffle in java, we just need to add the maven dependency:</p>

<p><code>&lt;properties&gt;&lt;br /&gt;
&lt;waffle.version&gt;1.5&lt;/waffle.version&gt;&lt;br /&gt;
&lt;/properties&gt;</code></p>

<p><dependency></p>

<p><groupId>com.github.dblock.waffle</groupId></p>

<p><artifactId>waffle-jna</artifactId></p>

<p><version>${waffle.version}</version></p>

<p></dependency></p>

<pre>&lt;dependency&gt;
 &lt;groupId&gt;net.java.dev.jna&lt;/&lt;wbr />groupId&gt;
 &lt;artifactId&gt;platform&lt;/&lt;wbr />artifactId&gt;
 &lt;version&gt;3.5.2&lt;/version&gt;
 &lt;/dependency&gt;</pre>

<p>Create a new instance of waffle.windows.auth.impl.WindowsAuthProviderImpl.</p>

<p>Here are a couple of scenario that you can do without any nasty setup in Java, Jboss, Tomcat etc.</p>

<h4 id="scenario-1-logon-a-user-and-get-his-domain-and-local-groups">Scenario 1: Logon a user and get his domain and local groups</h4>

<p>This calls Win32-LogonUser, checks the user token and extracts all local domain information.</p>

<p><code>IWindowsAuthProvider prov = new WindowsAuthProviderImpl();&lt;br /&gt;
IWindowsIdentity identity = prov.logonUser(&quot;userName&quot;, &quot;pwd&quot;);&lt;br /&gt;
System.out.println(&quot;User identity: &quot; + identity.getFqn());&lt;br /&gt;
for(IWindowsAccount group : identity.getGroups()) {&lt;br /&gt;
System.out.println(&quot; &quot; + group.getFqn() + &quot; (&quot; + group.getSidString() + &quot;)&quot;);&lt;br /&gt;
}</code></p>

<p>Output::</p>

<p><code>&lt;br /&gt;
User identity: acnna\darora&lt;br /&gt;
acnna\\None (S-1-5-21-42300245183-42300245183-3597729351-513)&lt;br /&gt;
Everyone (S-1-1-0)&lt;br /&gt;
acnna\\HomeUsers (S-1-5-21-42300245183-42300245183-3597729351-2418)&lt;br /&gt;
BUILTIN\Administrators (S-1-5-32-544)&lt;br /&gt;
BUILTIN\Users (S-1-5-32-545)&lt;br /&gt;
NT AUTHORITY\NETWORK (S-1-5-2)&lt;br /&gt;
</code></p>

<h4 id="scenario-2-active-directory-get-the-list-of-trusted-domains">Scenario 2: Active directory: get the list of trusted domains</h4>

<p><code>IWindowsAuthProvider prov = new WindowsAuthProviderImpl();&lt;br /&gt;
IWindowsDomain[] domains = prov.getDomains();&lt;br /&gt;
for(IWindowsDomain domain : domains) {&lt;br /&gt;
System.out.println(domain.getFqn() + &quot;: &quot; + domain.getTrustDirectionString());&lt;br /&gt;
}</code></p>

<p>Output::</p>

<h4 id="scenario-3-is-computer-active-on-a-domain">Scenario 3:: Is computer active on a domain?</h4>

<p><code>&lt;br /&gt;
IWindowsAuthProvider prov = new WindowsAuthProviderImpl();&lt;br /&gt;
IWindowsComputer computer = prov.getCurrentComputer();&lt;br /&gt;
System.out.println(computer.getComputerName());&lt;br /&gt;
System.out.println(computer.getJoinStatus());&lt;br /&gt;
System.out.println(computer.getMemberOf());&lt;br /&gt;
</code></p>

<p>For systems that run both with and without active directory you need to programmatically figure out whether a computer is joined to a domain or a workgroup. If it’s joined to a domain or a workgroup you want to know what domain the computer is joined to.</p>

<h4 id="scenario-4-negotiate-single-sign-on">Scenario 4: Negotiate Single Sign on</h4>

<p>This lets both client and server side to negotatite the sign on protocol. The code below, gets the token which can be shared between client and server and be used to lookup its domains.</p>

<p><code>&lt;br /&gt;
String securityPackage = &quot;Negotiate&quot;;&lt;br /&gt;
// client credentials handle&lt;br /&gt;
IWindowsCredentialsHandle clientCredentials = WindowsCredentialsHandleImpl.getCurrent(securityPackage);&lt;br /&gt;
clientCredentials.initialize();&lt;br /&gt;
// initial client security context&lt;br /&gt;
WindowsSecurityContextImpl clientContext = new WindowsSecurityContextImpl();&lt;br /&gt;
clientContext.setPrincipalName(Advapi32Util.getUserName());&lt;br /&gt;
clientContext.setCredentialsHandle(clientCredentials.getHandle());&lt;br /&gt;
clientContext.setSecurityPackage(securityPackage);&lt;br /&gt;
clientContext.initialize();&lt;br /&gt;
// accept on the server&lt;br /&gt;
WindowsAuthProviderImpl provider = new WindowsAuthProviderImpl();&lt;br /&gt;
IWindowsSecurityContext serverContext = null;&lt;br /&gt;
do&lt;br /&gt;
{&lt;br /&gt;
if (serverContext != null) {&lt;br /&gt;
// initialize on the client&lt;br /&gt;
SecBufferDesc continueToken = new SecBufferDesc(Sspi.SECBUFFER_TOKEN, serverContext.getToken());&lt;br /&gt;
clientContext.initialize(clientContext.getHandle(), continueToken);&lt;br /&gt;
}&lt;br /&gt;
// accept the token on the server&lt;br /&gt;
serverContext = provider.acceptSecurityToken(clientContext.getToken(), securityPackage);&lt;br /&gt;
} while (clientContext.getContinue() || serverContext.getContinue());</code></p>

<p>System.out.println(serverContext.getIdentity().getFqn());</p>

<p>for (IWindowsAccount group : serverContext.getIdentity().getGroups()) {</p>

<p>System.out.println(&#8221; &#8221; + group.getFqn());</p>

<p>}</p>

<p>serverContext.dispose();</p>

<p>clientContext.dispose();</p>

<p>clientCredentials.dispose();</p>

<p>&nbsp;</p>

<p>~Ciao</p>

                 
                
         
      
    </div>

    
   

    <div class="w3-container">
    	
      
     
	</div>



  


    
    
    
    
    <br>  
</div>



<div class="w3-container w3-card-2 w3-black">
<div class="w3-row">
  <div class="w3-col l2 m2 s12 w3-center">
  
    <img src="https://avatars3.githubusercontent.com/u/1176242?s=460&amp;v=4" width ="100px" class="w3-circle w3-center w3-margin-top w3-margin-bottom" alt="author" >
   
  </div>
  <div class="w3-col l10 m10 s12 ">
  <div class = "w3-container w3-margin-top">
    
    
  </div>
  </div>
  </div>
</div>

      
    <div class="w3-content" > 
      <div class="w3-bar w3-section">
	     
	      <a  href="/2015/12/26/how-to-set-up-apache-storm-on-mac-using-brew/" class="w3-btn w3-text-indigo w3-hover-green">
	          &#10094; How to set up Apache Storm on mac using brew
	      </a>
	    
	      <a class="w3-btn w3-right w3-text-indigo w3-hover-green" href="/2015/07/22/4-ways-to-set-up-datasources-in-jboss-as-7/">
	       4 ways to set up datasources in Jboss AS 7 &#10095;
	      </a>
  	  </div>
    </div>
	
 

  
  
  

      <div id="wrapads">
        <div class="adBanner">
         
        </div>
       </div>
      
      <div id="allowads" class="allowads-overlay">
  
        <div class="allowads-overlay-content">
        <div class="w3-panel w3-pink w3-large">
        

         <p> We notice you're using an adblocker.  If you like our webite please keep us running by whitelisting this site in your ad blocker. We’re serving quality, related ads only. Thank you!</p>
         
          <div class="w3-btn w3-green"  onclick="closeOverlay()">I've whitelisted your website.</div><br>
          <div class="w3-button w3-small"  onclick="closeOverlay()">Not now</div>
        </div>
        </div>
      </div>

      <script>
      function closeOverlay() {
        document.getElementById("allowads").style.width = "0%";
        document.getElementById("wrapads").style.height="1px";
      }

      function detectads() {
      var h = document.getElementById("wrapads").clientHeight;

      if (h==0){ document.getElementById("allowads").style.width = "100%";
      }
      }
      

     
      
      </script>
        </div>
        
          <script>
  shareurl=encodeURIComponent(location.protocol + '//' + location.host + location.pathname);
  sharetitle=encodeURIComponent(document.title);
    
  </script>
<div class="icon-bar">
<script>
document.write( '<a href="javascript:bookmark();" class="bookmark w3-tooltip"><i class="fa fa-bookmark"></i><span style="position:absolute;left:40px;bottom:18px" class="w3-text w3-small w3-tag w3-round w3-green ">Bookmark this page</span></a> ');

document.write( '<a href="http://www.facebook.com/sharer.php?u='+shareurl+'" onclick="window.open(this.href, \'mywin\',\'left=20,top=20,width=500,height=500,toolbar=1,resizable=0\'); return false;" class="facebook w3-tooltip"><i class="fa fa-facebook "></i><span style="position:absolute;left:40px;bottom:18px" class="w3-text w3-small w3-tag w3-round w3-green">Share to Facebook</span></a> ');

document.write( '<a href="https://twitter.com/share?url='+shareurl+'&amp;text='+sharetitle+'" onclick="window.open(this.href, \'mywin\',\'left=20,top=20,width=500,height=500,toolbar=1,resizable=0\'); return false;" class="twitter w3-tooltip"><i class="fa fa-twitter"></i><span style="position:absolute;left:40px;bottom:18px" class="w3-text w3-small w3-tag w3-round w3-green">Share to Twitter</span></a> ');
document.write( '<a href="https://plus.google.com/share?url='+shareurl+'" onclick="window.open(this.href, \'mywin\',\'left=20,top=20,width=500,height=500,toolbar=1,resizable=0\'); return false;" class="google w3-tooltip"><i class="fa fa-google"></i><span style="position:absolute;left:40px;bottom:18px" class="w3-text w3-small w3-tag w3-round w3-green">Share to Google Plus</span></a>');

document.write( '<a href="http://www.linkedin.com/shareArticle?mini=true&amp;url='+shareurl+'" onclick="window.open(this.href, \'mywin\',\'left=20,top=20,width=500,height=500,toolbar=1,resizable=0\'); return false;" class="linkedin w3-tooltip"><i class="fa fa-linkedin"></i><span style="position:absolute;left:40px;bottom:18px" class="w3-text w3-small w3-tag w3-round w3-green">Share to Linkedin</span></a>');

</script>

<script>
function bookmark(){

if ('sidebar' in window && 'addPanel' in window.sidebar) { 
                window.sidebar.addPanel(location.href,document.title,"");
            } else if(  false) { 
                window.external.AddFavorite(location.href,document.title); 
            } else { 
                alert('Press ' + (navigator.userAgent.toLowerCase().indexOf('mac') != - 1 ? 'Command/Cmd' : 'CTRL') + ' + D to bookmark this page.');
            }
        }

</script>
</div>
        
        
          
  

        

      </div>



    <footer id="footer" >
      <div class="w3-container w3-center w3-padding-32"> 
  
  <hr class="headfoot">
  <p>Powered by <a href="https://gohugo.io">Hugo</a> | Theme - <a href="https://github.com/jesselau76/hugo-w3-simple">Hugo W3 Simple</a>
  </p>
  &copy; <a href="http://javahabit.com">Dinesh Arora</a> 2019 | <a href="https://github.com/dinesh19aug">Github</a> | <a href="https://twitter.com/dinesh19aug">Twitter</a>  | <a href="/index.xml">RSS</a>
  
</div>

    </footer>



  </div>

  

  
    
      <div id="backtotop" class="w3-hide-small w3-hide-medium">

        <button onclick="topFunction()" class="w3-btn w3-red w3-large" style="width:160px">Back To Top
        &rarr;</button>

      </div>

      <script>
        function topFunction() {
          document.body.scrollTop = 0;
          document.documentElement.scrollTop = 0;
      }
      </script>


    
 
    
    <script>

    function isVisible(elem) {

      let coords = elem.getBoundingClientRect();

      let windowHeight = document.documentElement.clientHeight;

      
      let topVisible = coords.top > 0 && coords.top < windowHeight;
      let bottomVisible = coords.bottom < windowHeight && coords.bottom > 0;

      return topVisible || bottomVisible;
    }



    function showVisible() {
      for (let img of document.querySelectorAll('img')) {
        let realSrc = img.dataset.src;
        if (!realSrc) continue;

        if (isVisible(img)) {


          img.src = realSrc;

          img.dataset.src = '';
        }
      }
      if ( Array.from(document.querySelectorAll('[data-src]')).every(
        img => img.getAttribute('data-src') === '') ) {
        window.removeEventListener('scroll', showVisible)
      }

    }

    window.addEventListener('scroll', showVisible);
    showVisible();
  </script>


    
    
      <div class="progress-container" id="scrollbar">
        <div class="progress-bar" id="progress-bar"></div>
      </div>


    
<script>

window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  <!-- TOC -->
    

    if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
        document.getElementById("toc").style.display = "block";
    } else {
        document.getElementById("toc").style.display = "none";
    }
    
    <!-- cookie bar -->
    
<!-- Back to top -->
    
    if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
        document.getElementById("backtotop").style.display = "block";
    } else {
        document.getElementById("backtotop").style.display = "none";
    }
    
    <!-- scroll indicator -->
    
      var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      var scrolled = (winScroll / height) * 100;
      document.getElementById("progress-bar").style.width = scrolled + "%";
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
            document.getElementById("scrollbar").style.display = "block";
        } else {
            document.getElementById("scrollbar").style.display = "none";
        }


    

    <!-- allowads -->
    
       if (document.body.scrollTop > 2000 || document.documentElement.scrollTop > 2000) {
          detectads();
       }

    
}


</script>



  

</body>
</html>
